<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Branch Commits</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2ea043;
        }
        .branch-section {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .branch-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }
        .commit-item {
            background: #0d1117;
            border-left: 3px solid #1f6feb;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .main-branch { border-left-color: #1f6feb; }
        .feature-branch { border-left-color: #56d364; }
        .file-badge {
            display: inline-block;
            background: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin: 2px;
        }
        .success { color: #56d364; }
        .warning { color: #ffa657; }
        .error { color: #f85149; }
        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç Check Branch Commits</h1>
    
    <div class="section">
        <h2>Repository Analysis</h2>
        <button onclick="analyzeRepository()">Analyze Repository</button>
        <div id="analysis-result"></div>
    </div>
    
    <div class="section">
        <h2>Sync All Branch Commits</h2>
        <p>This will ensure all commits from all branches are in the main commits array</p>
        <button onclick="syncBranchCommits()">Sync Branch Commits</button>
        <div id="sync-result"></div>
    </div>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="window.location.href='index.html'">Dashboard</button>
        <button onclick="window.location.href='repo.html?repo=' + getRepoName()">View Repository</button>
        <button onclick="window.location.reload()">Refresh</button>
    </div>

    <script>
        function getRepoName() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('repo') || 'GitVersion';
        }
        
        function analyzeRepository() {
            const result = document.getElementById('analysis-result');
            const data = localStorage.getItem('githubSimulatorData');
            
            if (!data) {
                result.innerHTML = '<p class="error">‚ùå No data found</p>';
                return;
            }
            
            try {
                const repos = JSON.parse(data);
                const repoName = getRepoName();
                const repo = repos.find(r => r.name === repoName);
                
                if (!repo) {
                    result.innerHTML = `<p class="error">‚ùå Repository "${repoName}" not found</p>`;
                    return;
                }
                
                let html = `<h3>Repository: ${repo.name}</h3>`;
                
                // Main commits array
                const mainCommits = repo.commits || [];
                html += `
                    <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <p><strong>Main Commits Array:</strong> ${mainCommits.length} commits</p>
                    </div>
                `;
                
                // Branch analysis
                const branches = repo.branches || [];
                html += `<h4>Branches (${branches.length}):</h4>`;
                
                if (branches.length === 0) {
                    html += '<p class="warning">‚ö†Ô∏è No branches found</p>';
                } else {
                    let totalBranchCommits = 0;
                    
                    branches.forEach(branch => {
                        const branchCommits = branch.commits || [];
                        totalBranchCommits += branchCommits.length;
                        const isCurrent = branch.current || branch.name === repo.currentBranch;
                        
                        html += `
                            <div class="branch-section">
                                <div class="branch-header ${branch.name === 'main' ? 'main-branch' : 'feature-branch'}">
                                    üìå ${branch.name} 
                                    ${isCurrent ? '<span style="color: #56d364;">(current)</span>' : ''}
                                    ${branch.parent ? `<span style="color: #8b949e; font-size: 14px;"> from ${branch.parent}</span>` : ''}
                                </div>
                                <p><strong>Commits:</strong> ${branchCommits.length}</p>
                        `;
                        
                        if (branchCommits.length === 0) {
                            html += '<p class="warning">‚ö†Ô∏è No commits in this branch</p>';
                        } else {
                            branchCommits.forEach(commit => {
                                const files = commit.files || [];
                                html += `
                                    <div class="commit-item">
                                        <strong>${commit.message}</strong><br>
                                        <small>${commit.author} | ${commit.date}</small>
                                        ${files.length > 0 ? '<br>' + files.map(f => `<span class="file-badge">üìÑ ${f}</span>`).join('') : ''}
                                    </div>
                                `;
                            });
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `
                        <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <p><strong>Total Branch-Specific Commits:</strong> ${totalBranchCommits}</p>
                            ${totalBranchCommits !== mainCommits.length ? 
                                `<p class="warning">‚ö†Ô∏è Mismatch! Main array has ${mainCommits.length} commits but branches have ${totalBranchCommits} commits</p>
                                 <p>Click "Sync Branch Commits" to fix this.</p>` : 
                                `<p class="success">‚úÖ All commits are synced</p>`
                            }
                        </div>
                    `;
                }
                
                result.innerHTML = html;
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        function syncBranchCommits() {
            const result = document.getElementById('sync-result');
            const data = localStorage.getItem('githubSimulatorData');
            
            if (!data) {
                result.innerHTML = '<p class="error">‚ùå No data found</p>';
                return;
            }
            
            try {
                const repos = JSON.parse(data);
                const repoName = getRepoName();
                const repoIndex = repos.findIndex(r => r.name === repoName);
                
                if (repoIndex === -1) {
                    result.innerHTML = `<p class="error">‚ùå Repository "${repoName}" not found</p>`;
                    return;
                }
                
                const repo = repos[repoIndex];
                const branches = repo.branches || [];
                
                if (!repo.commits) {
                    repo.commits = [];
                }
                
                let added = 0;
                
                // Collect all commits from all branches
                branches.forEach(branch => {
                    if (!branch.commits || branch.commits.length === 0) return;
                    
                    branch.commits.forEach(branchCommit => {
                        // Ensure branch name is set
                        if (!branchCommit.branch) {
                            branchCommit.branch = branch.name;
                        }
                        
                        // Check if commit already exists in main array
                        const exists = repo.commits.some(c => 
                            c.message === branchCommit.message &&
                            c.author === branchCommit.author &&
                            c.date === branchCommit.date &&
                            c.branch === branchCommit.branch
                        );
                        
                        if (!exists) {
                            repo.commits.push({...branchCommit});
                            added++;
                        }
                    });
                });
                
                // Sort commits by timestamp
                repo.commits.sort((a, b) => {
                    const timeA = a.timestamp || 0;
                    const timeB = b.timestamp || 0;
                    return timeA - timeB;
                });
                
                // Save back
                repos[repoIndex] = repo;
                localStorage.setItem('githubSimulatorData', JSON.stringify(repos));
                
                result.innerHTML = `
                    <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <p class="success">‚úÖ Sync complete!</p>
                        <p><strong>Added:</strong> ${added} commits to main array</p>
                        <p><strong>Total commits:</strong> ${repo.commits.length}</p>
                        <p style="margin-top: 15px;">
                            <button onclick="window.location.reload()">Refresh to Re-analyze</button>
                            <button onclick="window.location.href='repo.html?repo=${repoName}'">View in App</button>
                        </p>
                    </div>
                `;
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        // Auto-analyze on load
        window.onload = function() {
            analyzeRepository();
        };
    </script>
</body>
</html>
