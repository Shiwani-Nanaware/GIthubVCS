<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Commits - Add Missing Files</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #0d1117;
            color: #c9d1d9;
        }
        .section {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #2ea043;
        }
        .danger-btn {
            background: #da3633;
        }
        .danger-btn:hover {
            background: #f85149;
        }
        .commit-item {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }
        .has-files {
            border-left: 3px solid #238636;
        }
        .no-files {
            border-left: 3px solid #f85149;
        }
        .file-badge {
            display: inline-block;
            background: rgba(56, 139, 253, 0.15);
            color: #58a6ff;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
            border: 1px solid rgba(56, 139, 253, 0.3);
        }
        .success {
            color: #56d364;
        }
        .error {
            color: #f85149;
        }
        .warning {
            color: #ffa657;
        }
        pre {
            background: #0d1117;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß Fix Commits - Add Missing File Information</h1>
    
    <div class="section">
        <h2>Step 1: Analyze Current Commits</h2>
        <button onclick="analyzeCommits()">Analyze Commits</button>
        <div id="analysis-result"></div>
    </div>
    
    <div class="section">
        <h2>Step 2: Auto-Fix Commits</h2>
        <p>This will try to extract filenames from commit messages and add them to the files array.</p>
        <button onclick="autoFixCommits()">Auto-Fix Commits</button>
        <div id="fix-result"></div>
    </div>
    
    <div class="section">
        <h2>Step 3: View Fixed Data</h2>
        <button onclick="viewFixedData()">View All Commits</button>
        <div id="view-result"></div>
    </div>
    
    <div class="section">
        <h2>Quick Actions</h2>
        <button onclick="window.location.href='index.html'">Go to Dashboard</button>
        <button onclick="window.location.href='repo.html?repo=TestRepo'">Open TestRepo</button>
        <button onclick="clearAndReload()" class="danger-btn">Clear All Data & Reload</button>
    </div>

    <script>
        function extractFilenameFromMessage(message) {
            const patterns = [
                /Added\s+(.+\.\w+)/i,
                /Updated\s+(.+\.\w+)/i,
                /Modified\s+(.+\.\w+)/i,
                /Deleted\s+(.+\.\w+)/i,
                /Removed\s+(.+\.\w+)/i,
                /Uploaded\s+(.+\.\w+)/i,
                /Created\s+file:\s*(.+\.\w+)/i,
                /Updated\s+file:\s*(.+\.\w+)/i,
                /file:\s*(.+\.\w+)/i,
                /:\s*(.+\.\w+)/,
                /(.+\.\w+)$/
            ];
            
            for (const pattern of patterns) {
                const match = message.match(pattern);
                if (match && match[1]) {
                    let filename = match[1].trim().replace(/['"]/g, '');
                    if (filename.includes('.') && filename.length > 0 && filename.length < 100) {
                        return filename;
                    }
                }
            }
            return null;
        }
        
        function analyzeCommits() {
            const result = document.getElementById('analysis-result');
            const data = localStorage.getItem('githubSimulatorData');
            
            if (!data) {
                result.innerHTML = '<p class="error">‚ùå No data found in localStorage</p>';
                return;
            }
            
            try {
                const repos = JSON.parse(data);
                let html = '<h3>Analysis Results:</h3>';
                let totalCommits = 0;
                let commitsWithFiles = 0;
                let commitsWithoutFiles = 0;
                
                repos.forEach(repo => {
                    html += `<h4>${repo.name}</h4>`;
                    
                    if (!repo.commits || repo.commits.length === 0) {
                        html += '<p class="warning">No commits found</p>';
                        return;
                    }
                    
                    repo.commits.forEach(commit => {
                        totalCommits++;
                        const hasFiles = commit.files && commit.files.length > 0;
                        
                        if (hasFiles) {
                            commitsWithFiles++;
                        } else {
                            commitsWithoutFiles++;
                        }
                        
                        const extractedFile = extractFilenameFromMessage(commit.message);
                        
                        html += `
                            <div class="commit-item ${hasFiles ? 'has-files' : 'no-files'}">
                                <strong>${commit.message}</strong><br>
                                <small>Branch: ${commit.branch || 'main'} | Date: ${commit.date}</small><br>
                                ${hasFiles ? 
                                    `<div style="margin-top: 5px;">
                                        ${commit.files.map(f => `<span class="file-badge">üìÑ ${f}</span>`).join('')}
                                    </div>` : 
                                    `<span class="error">‚ùå No files array</span>
                                     ${extractedFile ? `<span class="warning"> (Can extract: ${extractedFile})</span>` : ''}`
                                }
                            </div>
                        `;
                    });
                });
                
                html = `
                    <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <p><strong>Total Commits:</strong> ${totalCommits}</p>
                        <p class="success"><strong>With Files:</strong> ${commitsWithFiles}</p>
                        <p class="error"><strong>Without Files:</strong> ${commitsWithoutFiles}</p>
                    </div>
                ` + html;
                
                result.innerHTML = html;
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        function autoFixCommits() {
            const result = document.getElementById('fix-result');
            const data = localStorage.getItem('githubSimulatorData');
            
            if (!data) {
                result.innerHTML = '<p class="error">‚ùå No data found</p>';
                return;
            }
            
            try {
                const repos = JSON.parse(data);
                let fixed = 0;
                let skipped = 0;
                
                repos.forEach(repo => {
                    if (!repo.commits) return;
                    
                    repo.commits.forEach(commit => {
                        // Skip if already has files
                        if (commit.files && commit.files.length > 0) {
                            skipped++;
                            return;
                        }
                        
                        // Try to extract filename from message
                        const extractedFile = extractFilenameFromMessage(commit.message);
                        
                        if (extractedFile) {
                            commit.files = [extractedFile];
                            fixed++;
                        } else {
                            // Set empty array if no file can be extracted
                            commit.files = [];
                            skipped++;
                        }
                    });
                });
                
                // Save back to localStorage
                localStorage.setItem('githubSimulatorData', JSON.stringify(repos));
                
                result.innerHTML = `
                    <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                        <p class="success">‚úÖ Fixed ${fixed} commits</p>
                        <p class="warning">‚ö†Ô∏è Skipped ${skipped} commits (already had files or no filename found)</p>
                        <p style="margin-top: 15px;">
                            <button onclick="window.location.reload()">Refresh Page</button>
                            <button onclick="window.location.href='repo.html?repo=TestRepo'">View in App</button>
                        </p>
                    </div>
                `;
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        function viewFixedData() {
            const result = document.getElementById('view-result');
            const data = localStorage.getItem('githubSimulatorData');
            
            if (!data) {
                result.innerHTML = '<p class="error">‚ùå No data found</p>';
                return;
            }
            
            try {
                const repos = JSON.parse(data);
                let html = '';
                
                repos.forEach(repo => {
                    html += `<h4>${repo.name}</h4>`;
                    
                    if (!repo.commits || repo.commits.length === 0) {
                        html += '<p>No commits</p>';
                        return;
                    }
                    
                    repo.commits.forEach(commit => {
                        const hasFiles = commit.files && commit.files.length > 0;
                        
                        html += `
                            <div class="commit-item ${hasFiles ? 'has-files' : 'no-files'}">
                                <strong>${commit.message}</strong><br>
                                <small>Branch: ${commit.branch || 'main'}</small><br>
                                ${hasFiles ? 
                                    `<div style="margin-top: 5px;">
                                        ${commit.files.map(f => `<span class="file-badge">üìÑ ${f}</span>`).join('')}
                                    </div>` : 
                                    `<span class="warning">‚ö†Ô∏è No files</span>`
                                }
                            </div>
                        `;
                    });
                });
                
                result.innerHTML = html;
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Error: ${e.message}</p>`;
            }
        }
        
        function clearAndReload() {
            if (confirm('Are you sure? This will delete ALL data!')) {
                localStorage.clear();
                alert('Data cleared! Page will reload.');
                window.location.reload();
            }
        }
        
        // Auto-analyze on load
        window.onload = function() {
            analyzeCommits();
        };
    </script>
</body>
</html>
